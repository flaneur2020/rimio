name: Integration

on:
  pull_request:
  workflow_dispatch:
    inputs:
      run_s3_integration:
        description: "Run optional 012 S3/MinIO integration case"
        required: false
        default: false
        type: boolean

concurrency:
  group: integration-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  integration:
    name: Run integration suite
    runs-on: ubuntu-latest
    timeout-minutes: 45

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Build amberio server (release)
        run: cargo build --release -p amberio-server --bin amberio

      - name: Run base integration tests
        env:
          AMBERIO_REDIS_URL: redis://127.0.0.1:6379
          AMBERIO_ENABLE_S3_IT: "0"
        run: |
          python3 integration/run_all.py \
            --binary target/release/amberio \
            --redis-url redis://127.0.0.1:6379

      - name: Start MinIO for optional S3 case
        if: ${{ vars.AMBERIO_ENABLE_S3_IT == '1' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_s3_integration == 'true') }}
        run: |
          docker run -d --name amberio-minio \
            -p 9000:9000 \
            -p 9001:9001 \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            -e MINIO_API_ROOT_ACCESS=on \
            quay.io/minio/minio server /data --console-address :9001

          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:9000/minio/health/live >/dev/null; then
              break
            fi
            sleep 1
          done

          docker run --rm --network host --entrypoint /bin/sh minio/mc -c '
            mc alias set local http://127.0.0.1:9000 minioadmin minioadmin &&
            mc mb --ignore-existing local/amberio-it
          '

      - name: Run optional S3 integration case (012)
        if: ${{ vars.AMBERIO_ENABLE_S3_IT == '1' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_s3_integration == 'true') }}
        env:
          AMBERIO_REDIS_URL: redis://127.0.0.1:6379
          AMBERIO_S3_ENDPOINT: http://127.0.0.1:9000
          AMBERIO_S3_BUCKET: amberio-it
          AMBERIO_S3_REGION: us-east-1
          AMBERIO_S3_ACCESS_KEY_ID: minioadmin
          AMBERIO_S3_SECRET_ACCESS_KEY: minioadmin
        run: |
          python3 integration/012_archive_write_through_s3_minio.py \
            --binary target/release/amberio \
            --redis-url redis://127.0.0.1:6379 \
            --s3-endpoint http://127.0.0.1:9000 \
            --s3-bucket amberio-it \
            --s3-region us-east-1 \
            --s3-access-key-id minioadmin \
            --s3-secret-access-key minioadmin
